def get_credentials():
    creds = None

    if "token_data" in st.session_state:
        try:
            creds = Credentials.from_authorized_user_info(
                st.session_state.token_data, SCOPES
            )
        except Exception:
            creds = None

    if creds and creds.expired and creds.refresh_token:
        try:
            creds.refresh(Request())
            st.session_state.token_data = json.loads(creds.to_json())
            return creds
        except Exception:
            creds = None

    if creds and creds.valid:
        return creds

    try:
        client_config = json.loads(st.secrets["GOOGLE_CREDENTIALS"])
        redirect_uri = st.secrets["REDIRECT_URI"]
    except Exception as e:
        st.error("‚ùå Secrets do Google n√£o configurados.")
        st.stop()

    params = st.query_params
    if "code" in params:
        try:
            flow = Flow.from_client_config(
                client_config,
                scopes=SCOPES,
                redirect_uri=redirect_uri
            )
            flow.fetch_token(code=params["code"])
            creds = flow.credentials
            st.session_state.token_data = json.loads(creds.to_json())
            st.query_params.clear()
            st.rerun()
        except Exception as e:
            st.error(f"‚ùå Erro ao processar login: {e}")
            st.stop()

    flow = Flow.from_client_config(
        client_config,
        scopes=SCOPES,
        redirect_uri=redirect_uri
    )
    auth_url, _ = flow.authorization_url(
        prompt="consent",
        access_type="offline"
    )

    # DEBUG TEMPOR√ÅRIO
    st.warning("üîç DEBUG - URL gerada:")
    st.code(auth_url)

    st.markdown("## üîê Autentica√ß√£o necess√°ria")
    st.markdown("Clique no bot√£o abaixo para fazer login com sua conta Google:")
    st.markdown(f"""
        <a href="{auth_url}" target="_self">
            <button style="
                background-color: #4285F4;
                color: white;
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                font-family: Arial;
            ">
                üîë Entrar com Google
            </button>
        </a>
    """, unsafe_allow_html=True)
    st.stop()
